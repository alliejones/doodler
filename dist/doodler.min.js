function Queue(t,o){this.array=[],this.id=t,this.local=o||!1}function Canvas(t){this.el=document.createElement("canvas"),this.ctr=document.getElementById(t.id),this.ctx=this.el.getContext("2d"),this.ctr.appendChild(this.el),this.prevMouseCoords={x:null,y:null},this.mouseCoords={x:null,y:null},this.curMouseCoords={x:null,y:null},this.el.width=t.width,this.el.height=t.height,this.ctx.lineCap="round",this.ctx.lineJoin="round",this.ctx.strokeStyle="black",this.localQueue=null,this.queues={},this.cmds=[],this.colors={},this.widths={},t.readOnly||(this.ctr.addEventListener("mousedown",this._onMousedown.bind(this)),window.addEventListener("selectstart",function(){return!1}),window.addEventListener("mousemove",this._onMousemove.bind(this)),window.addEventListener("mouseup",this._onMouseup.bind(this))),this.loop=null,this.nextTick()}Queue.prototype.fromString=function(t){for(var o=(""+t).split(";"),e=0,s=o.length;s>e;e++)this.queue(o[e])},Queue.prototype.dequeue=function(){return this.array.shift()},Queue.prototype.queue=function(t){this.local&&wsChat.send(t,"drawing"),this.array.push(t)},Queue.prototype.toString=function(){return this.array.join(";")},Queue.prototype.isEmpty=function(){return 0>=this.array.length},Canvas.prototype.registerQueue=function(t,o){this.queues[t]=o},Canvas.prototype.nextTick=function(){for(var t in this.queues){var o=this.queues[t];o.isEmpty()||this.processCommand(o.dequeue())}this.loop=window.setTimeout(this.nextTick.bind(this),0)},Canvas.prototype.processCommand=function(t){var o=(""+t).split(",");if(4===o.length)this._line.apply(this,o);else{var e=this.cmds[o[0]].slice(0),s="_"+e.shift();this[s].apply(this,e)}},Canvas.prototype._mapCoords=function(t,o){var e=this.el.getBoundingClientRect();return{x:t-e.left*(this.el.width/e.width),y:o-e.top*(this.el.height/e.height)}},Canvas.prototype._onMousedown=function(t){this._startDrawing(t)},Canvas.prototype._onMouseup=function(){this._stopDrawing()},Canvas.prototype._onMousemove=function(t){var o=this._windowScrollPosition();this.curMouseCoords=this._mapCoords(t.pageX-o.left,t.pageY-o.top)},Canvas.prototype._windowScrollPosition=function(){var t=document.documentElement,o=document.body,e=t&&t.scrollLeft||o&&o.scrollLeft||0,s=t&&t.scrollTop||o&&o.scrollTop||0;return{left:e,top:s}},Canvas.prototype._startDrawing=function(t){var o=this._mapCoords(t.pageX,t.pageY);this.recordingLoop=window.setInterval(this._draw.bind(this),this.recordingInterval),this.ctx.moveTo(o.x,o.y),this.ctx.beginPath()},Canvas.prototype._stopDrawing=function(){this.ctx.beginPath(),this.prevMouseCoords={x:null,y:null},this.mouseCoords={x:null,y:null},window.clearInterval(this.recordingLoop),this.recordingLoop=null},Canvas.prototype.setStrokeColor=function(t){this.localQueue.queue(this.colors[t])},Canvas.prototype._setStrokeColor=function(t){this.ctx.strokeStyle=t},Canvas.prototype.registerStrokeColor=function(t){this.colors.hasOwnProperty(t)||(this.cmds.push(["setStrokeColor",t]),this.colors[t]=this.cmds.length-1)},Canvas.prototype.setStrokeWidth=function(t){this.localQueue.queue(this.widths[t])},Canvas.prototype._setStrokeWidth=function(t){this.ctx.lineWidth=t},Canvas.prototype.registerStrokeWidth=function(t){this.widths.hasOwnProperty(t)||(this.cmds.push(["setStrokeWidth",t]),this.widths[t]=this.cmds.length-1)},Canvas.prototype._draw=function(){var t=this.prevMouseCoords.x=this.mouseCoords.x,o=this.prevMouseCoords.y=this.mouseCoords.y,e=this.mouseCoords.x=this.curMouseCoords.x,s=this.mouseCoords.y=this.curMouseCoords.y;(null===t||null===o)&&(t=e,o=s),this.line(t,o,e,s)},Canvas.prototype.line=function(t,o,e,s){this.localQueue.queue([Math.floor(t),Math.floor(o),Math.floor(e),Math.floor(s)].join(","))},Canvas.prototype._line=function(t,o,e,s){this.ctx.beginPath(),this.ctx.moveTo(t,o),this.ctx.lineTo(e,s),this.ctx.stroke()},Canvas.prototype.translate=function(t,o){this.ctx.save(),this.ctx.translate(t,o)},Canvas.prototype.undoTranslate=function(){this.ctx.restore()},Canvas.prototype.erase=function(){this.ctx.clearRect(0,0,this.el.width,this.el.height)},Canvas.prototype.fromString=function(t){this.localQueue.fromString(t)};